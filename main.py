import os
import time
import requests
from prettytable import PrettyTable
import yara
import platform
import malware_scanner

if __name__ == "__main__":

    directory_to_clear = r"C:\Users\alori\.vscode\malware detection system\Malware-Detection-System"  # Change this to the directory containing the _pycache_ directory
    malware_scanner.clear_pycache(directory_to_clear)

    url = "https://raw.githubusercontent.com/eminunal1453/Various-Malware-Hashes/main/hashes.txt"
    response = requests.get(url)
    malicious_hashes = set(response.text.splitlines())
    malware_classification = {
        "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8": "Ransomware",
        "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855": "Trojan",
        "8754c2a98e3b9c86aa49d4a35b8835e5fc6d5e6f53d6bce44a7f8db9c524de7a": "Virus",
        "3dc3c3f1bce75e029b1c7a8db9a20dfb2c6f68c925b1898db0d49f7a1d0520a6": "Spyware",
        "d301f9c47a8dd8331c4597feefcb056d08e3a3b4c4f4d03f9c1436a1a5f5b6b5": "Adware",
        "1e8a9f5127d527fb9c97d7fd8be2b883cc7f75e20e437d7b19db69b42c42220c": "Worm"
    }

    yara_rules = yara.compile("malware_rules.yar")

    directories_to_scan = []
    while True:
        directory = input("Enter a directory to scan (or type 'quit' to exit): ")
        if directory.lower() == "quit":
            break
        if os.path.isdir(directory):
            directories_to_scan.append(directory)
        else:
            print(f"The directory '{directory}' does not exist.")

    start_time = time.time()
    counter = [0]
   
    table = PrettyTable()
    table.field_names = ["File Path", "Malware Type"]

    try:
        for directory in directories_to_scan:
            counter, table = malware_scanner.scan_directory(directory, malicious_hashes, malware_classification, yara_rules, counter, table)
    except KeyboardInterrupt:
        print("The program has been stopped by the user")
    
    end_time = time.time()
    elapsed_time = end_time - start_time

    os.system('cls' if platform.system() == 'Windows' else 'clear')  
    if len(table.rows) == 0:  # Check if no rows were added to the table
        print("No suspicious files found during the scan.")
    else:
        print(table)
    print(f"\nTotal number of scanned files: {counter[0]}")
    print(f"Program run time: {elapsed_time:.2f} seconds")
